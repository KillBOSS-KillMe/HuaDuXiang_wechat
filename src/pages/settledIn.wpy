<template>
  <view class="wrap">
    <form @submit="submit" wx:if="{{status == -10 || status == 10}}">
      <view class="settle-list">
        <view class="com-item">
          <view class="title">商铺账号</view>
          <input type="text" name="admin" placeholder="商铺账号(6-20位字母数字组合)"  value="{{joinInfo.seller_name}}"/>
        </view>
        <view class="com-item">
          <view class="title">商铺密码</view>
          <input type="text" name="password" placeholder="商铺密码(6-20位字母数字组合)" value="{{joinInfo.seller_psw}}"/>
        </view>
        <view class="com-item">
          <view class="title">商铺名称</view>
          <input type="text" name="name" placeholder="请输入商铺名称" value="{{joinInfo.store_name}}"/>
        </view>
        <view class="com-item">
          <view class="title">商铺编号</view>
          <input type="text" name="code" placeholder="商铺编号(6-20位字母数字组合)" value="{{joinInfo.store_code}}" />
        </view>
        <view class="com-item">
          <view class="title">联系人</view>
          <input type="text" name="contacts" placeholder="请输入联系人姓名"  value="{{joinInfo.contacts_name}}" />
        </view>
        <view class="com-item">
          <view class="title">联系电话</view>
          <input type="number" name="phone" placeholder="请输入联系电话" value="{{joinInfo.contacts_phone}}" />
        </view>
        <view class="com-item">
          <view class="title">商铺地址</view>
          <input type="text" name="address" placeholder="请输入商铺地址"  value="{{joinInfo.company_address_detail}}"/>
        </view>
        <view class="com-item">
          <view class="title">店铺分类</view>
          <picker bindchange="storeClassChange" range="{{storeClass}}"  range-key="sc_name">
            <input type="text" placeholder="请选择店铺分类" value="{{storeClass[storeClassIndex].sc_name}}" disabled />
          </picker>
        </view>
        <view class="com-item">
          <view class="title">店铺等级</view>
          <picker bindchange="storeGradeChange" range="{{storeGrade}}"  range-key="sg_name">
            <input type="text" placeholder="请选择店铺等级" value="{{storeGrade[storeGradeIndex].sg_name}}" disabled />
          </picker>
        </view>
        <view class="com-item">
          <view class="title">开店时间</view>
          <picker bindchange="timeChange" value="{{timeIndex}}" range="{{timeArr}}" range-key="num">
            <input type="number" placeholder="请选择开店时间"  value="{{timeArr[timeIndex].num}}"  disabled />
          </picker>
          <text>年</text>
        </view>
        <view class="com-item">
          <view class="title">平台使用费</view>
          <input type="text" placeholder="平台使用费" value="{{useCostPrice}}元" disabled />
        </view>
        <view class="com-item">
          <view class="title">商家保证金</view>
          <input type="text" placeholder="商家保证金" value="{{bondPrice}}元" disabled />
        </view>
        <view class="com-item remarks">
          <view class="title">入驻商备注</view>
          <textarea placeholder="请输入备注" name="remarks" value="{{joinInfo.remark}}"></textarea>
        </view>
      </view>

      <button class="settled-btn" form-type="submit">提交申请</button>
    </form>
    <view class="examine" wx:if="{{status == 11}}">
      <image class="examine-img" src="/assets/img/image43.png" />
    </view>
    <view wx:if="{{status == 40}}">
      <view class="settle-list">
        <view class="com-item">
          <view class="title">商铺账号</view>
          <input type="text" name="admin" placeholder="商铺账号(6-20位字母数字组合)"  disabled value="{{joinInfo.seller_name}}"/>
        </view>
        <view class="com-item">
          <view class="title">商铺密码</view>
          <input type="text" name="password" placeholder="商铺密码(6-20位字母数字组合)" disabled value="{{joinInfo.seller_psw}}"/>
        </view>
        <view class="com-item">
          <view class="title">商铺名称</view>
          <input type="text" name="name" placeholder="请输入商铺名称" disabled value="{{joinInfo.store_name}}"/>
        </view>
        <view class="com-item">
          <view class="title">商铺编号</view>
          <input type="text" name="code" placeholder="商铺编号(6-20位字母数字组合)" disabled value="{{joinInfo.store_code}}" />
        </view>
        <view class="com-item">
          <view class="title">联系人</view>
          <input type="text" name="contacts" placeholder="请输入联系人姓名" disabled  value="{{joinInfo.contacts_name}}" />
        </view>
        <view class="com-item">
          <view class="title">联系电话</view>
          <input type="number" name="phone" placeholder="请输入联系电话" disabled value="{{joinInfo.contacts_phone}}" />
        </view>
        <view class="com-item">
          <view class="title">商铺地址</view>
          <input type="text" name="address" placeholder="请输入商铺地址"  disabled value="{{joinInfo.company_address_detail}}"/>
        </view>
        <view class="com-item">
          <view class="title">店铺分类</view>
          <picker bindchange="storeClassChange" range="{{storeClass}}"  range-key="sc_name" disabled>
            <input type="text" placeholder="请选择店铺分类" value="{{storeClass[storeClassIndex].sc_name}}" disabled />
          </picker>
        </view>
        <view class="com-item">
          <view class="title">店铺等级</view>
          <picker bindchange="storeGradeChange" range="{{storeGrade}}"  range-key="sg_name" disabled>
            <input type="text" placeholder="请选择店铺等级" value="{{storeGrade[storeGradeIndex].sg_name}}" disabled />
          </picker>
        </view>
        <view class="com-item">
          <view class="title">开店时间</view>
          <picker bindchange="timeChange" value="{{timeIndex}}" range="{{timeArr}}" range-key="num" disabled>
            <input type="number" placeholder="请选择开店时间"  value="{{timeArr[timeIndex].num}}"  disabled />
          </picker>
          <text>年</text>
        </view>
        <view class="com-item">
          <view class="title">平台使用费</view>
          <input type="text" placeholder="平台使用费" value="{{useCostPrice}}元" disabled />
        </view>
        <view class="com-item">
          <view class="title">商家保证金</view>
          <input type="text" placeholder="商家保证金" value="{{bondPrice}}元" disabled />
        </view>
        <view class="com-item remarks">
          <view class="title">入驻商备注</view>
          <textarea placeholder="请输入备注" name="remarks" value="{{joinInfo.remark}}" disabled></textarea>
        </view>
      </view>
      <navigator hover-class="none" url="/pages/merchantIndex?store_id={{store_id}}" class="settled-btn" form-type="submit" >前往店铺</navigator>
    </view>
  </view>
</template>

<script>
import wepy from 'wepy';
var api = require('../api.js');
import { ajax } from '../ajax.js';


export default class Index extends wepy.page {
  config = {
    navigationBarTitleText: '商家入驻'
  };
  components = {};

  mixins = [];

  data = {
    status: 0, // -10 没入驻   11交完钱审核中   20提交信息成功  31 交钱审核失败    40入驻成功
    storeGrade: [],  // 入驻店铺等级
    timeArr: [{num: 1},{num: 2},{num: 3}],
    storeGradeIndex: 0,
    timeIndex: 0,
    useCostPrice: 0, // 平台使用费用
    bondPrice: 0, // 商家保证金
    storeClass: [], // 店铺分类
    storeClassIndex: 0, //店铺分类索引
    store_id: '', // 店铺id
    joinInfo: {}
  };

  computed = {
    useCostPrice() {
      var num = this.timeArr[this.timeIndex].num
      var price = this.storeGrade[this.storeGradeIndex] && this.storeGrade[this.storeGradeIndex].sg_price
      return (Number(num) * Number(price)).toFixed(2)
    },
    bondPrice() {
      var price = this.storeClass[this.storeClassIndex] && this.storeClass[this.storeClassIndex].sc_bail
      return Number(price).toFixed(2)
    }
  };
  onShow() {}
  watch = {}
  methods = {
    submit(e) {
      console.log(e.detail.value)
      var {admin, password, name, code, contacts, phone, address, remarks} = e.detail.value
      if(!/^(\w){6,20}$/.test(admin)) {
        wx.showToast({
          title: '请输入6至20位商铺账号',
          icon: 'none'
        })
        return false
      }
      if(!/^(\w){6,20}$/.test(password)) {
        wx.showToast({
          title: '请输入6至20位密码',
          icon: 'none'
        })
        return false
      }
      if(!name) {
        wx.showToast({
          title: '请输入商铺名称',
          icon: 'none'
        })
        return false
      }
      if(!/^(\w){6,20}$/.test(code)) {
        wx.showToast({
          title: '请输入6至20位商铺编号',
          icon: 'none'
        })
        return false
      }
      if(!contacts) {
        wx.showToast({
          title: '请输入联系人姓名',
          icon: 'none'
        })
        return false
      }
      if(phone.length != 11) {
        wx.showToast({
          title: '请输入正确的联系电话',
          icon: 'none'
        })
        return false
      }
      if(!address) {
        wx.showToast({
          title: '请输入商铺地址',
          icon: 'none'
        })
        return false
      }
      if(!remarks) {
        wx.showToast({
          title: '请输入备注',
          icon: 'none'
        })
        return false
      }
      ajax({
        url: api.addStore,
        data: {
          store_name: name, //'店铺名',
          store_code: code, //'商家自定编码',
          contacts_name: contacts, //'商家联系人',
          contacts_phone: phone, //'商家联系电话',
          company_address_detail: address, //'商家地址',
          remark: remarks, //'入驻申请备注',
          joinin_year: this.timeArr[this.timeIndex].num, //'入驻时长',
          sc_id:  this.storeClass[this.storeClassIndex].sc_id, //'店铺分类编号',
          sc_name: this.storeClass[this.storeClassIndex].sc_name, //'店铺分类名称',
          sc_bail: this.storeClass[this.storeClassIndex].sc_bail, //'店铺分类保证金',
          sg_id: this.storeGrade[this.storeGradeIndex].sg_id, //'店铺等级编号',
          sg_name: this.storeGrade[this.storeGradeIndex].sg_name, //'店铺等级名称',
          sg_info: this.storeGrade[this.storeGradeIndex].sg_price, //'店铺等级价格',
          seller_name: admin, //'卖家账号'
          seller_psw: password, // 密码
        }
      }).then(res => {
        wx.showToast({
          title: res.datas.msg,
          icon: 'none'
        })
      })
      // this.$navigate({ url: 'settledInPay' });
    },
    storeGradeChange(e) {
      var value = e.detail.value
      this.storeGradeIndex = value

    },
    timeChange(e){
      this.timeIndex = e.detail.value
    },
    storeClassChange(e) {
      this.storeClassIndex = e.detail.value

    }
  };

  events = {};

  async onLoad() {
    var that = this
      // 判断是否提交入驻申请
    await ajax({
      url: api.isJoin,
      type: 'get',
    }).then(res => {
      this.status = res.datas.state
      if(res.datas.state == 10 || res.datas.state == 40) {
        this.joinInfo = res.datas.data
        var joinin_year = this.joinInfo.joinin_year
        this.timeArr.forEach((item, index) => {
          if(item.num == joinin_year) {
            this.timeIndex = index
          }
        })

      }
      this.store_id = res.datas.store_id
      this.$apply()
    })
    // 店铺等级
    ajax({
      url: api.getStoreGrade
    }).then(res => {
      this.storeGrade = res.datas.data
      var sg_id = this.joinInfo.sg_id 
      res.datas.data.forEach((item, index) => {
        if(item.sg_id == sg_id) {
          this.storeGradeIndex = index
        }
      })
      this.$apply()
    })
    // 店铺分类
    ajax({
      url: api.getStoreClass
    }).then(res => {
      this.storeClass = res.datas.data || []
      var sc_id = this.joinInfo.sc_id 
      res.datas.data.forEach((item, index) => {
        if(item.sc_id == sc_id) {
          this.storeClassIndex = index
        }
      })
      this.$apply()
    })


    
  }
}
</script>

<style lang="less">
.settle-list {
  padding: 0 30rpx;
  .com-item {
    height: 100rpx;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #f1f1f1;
    .title {
      font-weight: bold;
      font-size: 30rpx;
      width: 160rpx;
    }
    input {
      height: 100rpx;
      flex: 1;
      color: #333;
      font-size: 28rpx;
    }
    > text {
      font-weight: bold;
      font-size: 30rpx;
    }
    picker {
      flex: 1;
    }
  }
  .remarks {
    height: auto;
    padding: 36rpx 0;
    .title {
      align-self: flex-start;
    }
    textarea {
      height: 160rpx;
      border-radius: 10rpx;
      border: 1px solid #dfdfdf;
      flex: 1;
      box-sizing: border-box;
      padding: 20rpx;
    }
  }
}
.settled-btn {
  width: 690rpx;
  height: 88rpx;
  line-height: 88rpx;
  border-radius: 10rpx;
  color: #fff;
  font-size: 30rpx;
  text-align: center;
  background: #ff2228;
  margin: 30rpx auto 30rpx; 
  // position: absolute;
  // bottom: 60rpx;
  // left: 50%;
  // transform: translate3d(-50%, 0, 0);
}
.examine {
  position: relative;
  height: 100vh;
  .examine-img {
    position: absolute;
    left: 50%;
    top: 30%;
    transform: translateX(-50%);
    width: 330rpx;
    height: 256rpx;
  }
}
</style>

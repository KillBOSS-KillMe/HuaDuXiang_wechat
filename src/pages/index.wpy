<style lang="less">
@hundred: 100%;
.wrap {
  background: #f9f9f9;
}
//搜索

.search-wrap {
  padding: 10rpx 30rpx;
  background: #f9f9f9;
  .search {
    width: 690rpx;
    height: 70rpx;
    display: flex;
    align-items: center;
    background: #ececec;
    border-radius: 36rpx;
    .search-img {
      width: 48rpx;
      height: 48rpx;
      margin: 0 26rpx;
    }
    .inputSerach {
      margin-right: 26rpx;
      flex: 1;
      height: 70rpx;
    }
  }
}

// 轮播
.mainWheel {
  width: @hundred;
  height: 380rpx;
  margin-top: 20rpx;
  .slide-image {
    width: 100%;
    height: 100%;
  }
  swiper {
    width: 100%;
    height: 100%;
  }
}
//中间选项
.mainChoose {
  width: @hundred;
  height: 380rpx;
  background: #fff;
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  justify-content: center;
  .chooseItem {
    width: 25%;
    height: 50%;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    .chooseImg {
      width: 72rpx;
      height: 72rpx;
    }
    .chooseText {
      padding-top: 16rpx;
      color: #333333;
      font-size: 26rpx;
      text-align: center;
    }
  }
}
//秒杀区
.seckill {
  margin-top: 20rpx;
  // 标题
  .seckilltitle {
    display: flex;
    flex-direction: row;
    justify-content: space-between;

    color: #282828;
    font-size: 32rpx;
    font-weight: bold;
    padding: 30rpx;
    background: #fff;
    .beginTime {
      color: #9e9e9e;
      font-weight: normal;
      font-size: 26rpx;
    }
  }
  // 倒计时
  .seckillCountdown {
    width: @hundred;
    text-align: center;
    padding: 20rpx 0;
    color: #282828;
    font-size: 28rpx;
    font-weight: bold;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    .title {
      padding-right: 18rpx;
    }
    .count-down-wrap {
      display: flex;
      align-items: center;
      height: 38rpx;
      > text {
        width: 38rpx;
        height: 38rpx;
        text-align: center;
        background: #525252;
        border-radius: 2rpx;
        color: #fff;
        font-size: 24rpx;
        font-weight: 500;
        line-height: 38rpx;
      }
      > view {
        font-size: 18rpx;
        margin: 0 8rpx;
      }
    }
  }
}
// 商品
.saleShopWrap {
  width: 100%;
  height: 100%;
  background: #f9f9f9;
  padding-bottom: 160rpx;
  .saleShop {
    width: 92%;
    height: 100%;
    margin: 20rpx auto;
    margin-bottom: 2%;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: space-between;

    // item商品
    .shopview {
      background: #fff;
      width: 335rpx;
      height: 488rpx;
      display: inline-block;
      justify-content: center;
      flex-direction: column;
      align-items: center;
      padding: 20rpx 0rpx;
      margin-bottom: 19rpx;
      border-radius: 20rpx;
      image {
        width: 327rpx;
        height: 327rpx;
      }
      .saleTag {
        font-size: 30rpx;
        font-weight: bold;
        color: #333;
        padding: 30rpx;
        text {
          width: 290rpx;
          display: block;
        }
      }
      .salep {
        font-size: 28rpx;
        color: red;
        font-weight: bold;
        padding-left: 30rpx;
      }
      .salesmple {
        font-size: 24rpx;
        color: red;
        font-weight: normal;
      }
      .saleprice {
        font-weight: bolder;
        color: red;
        font-size: 42rpx;
      }
      .saleexprice {
        color: #666;
        font-size: 24rpx;
        font-weight: normal;
        padding-left: 25rpx;
        text-decoration: line-through;
      }
      .saletag {
        width: 60rpx;
        background: red;
        text-align: center;
        line-height: 20rpx;
        font-size: 10px;
        padding: 8rpx;
        color: white;
        border-radius: 10rpx;
        margin-left: 3%;
        margin-top: -2%;
      }
    }
  }
}

#getUserInfo {
  position: fixed;
  top: 0%;
  left: 0;
  bottom: 0;
  right: 0;
  opacity: 0;
  z-index: 999;
}
</style>
<template>
  <view class="wrap">
    <view class="search-wrap" @tap="navSearch">
      <view class="search">
        <image class="search-img" src="/assets/img/image10.png" />
        <input class="inputSerach" disabled />
      </view>
    </view>
    <!-- 轮播 -->
    <view class="mainWheel">
      <swiper indicator-dots="true" autoplay="true" interval="2000" duration="500" circular="true">
        <repeat for="{{imgUrls}}" item="item">
          <swiper-item>
            <image src="http://img011.hc360.cn/g2/M06/45/BF/wKhQuFLfLl-EakIIAAAAAGqrml0128.jpg" class="slide-image" />
          </swiper-item>
        </repeat>
      </swiper>
    </view>
    <!-- 中间选项 -->
    <view class="mainChoose">
      <repeat for="{{ChooesData}}" item="item">
        <view class="chooseItem" @tap="tapName('{{item.id}}')">
          <image class="chooseImg" src="{{item.img}}" />
          <text class="chooseText">{{item.title}}</text>
        </view>
      </repeat>
    </view>
    <!-- 秒杀专区 -->
    <view class="seckill">
      <view class="seckilltitle">
        <view>秒杀专区</view>
        <view class="beginTime">下一场{{beginTime}}开始</view>
      </view>
      <!-- 倒计时 -->
      <view class="seckillCountdown" wx:if="{{wxTimerList.firstTimer.wxTimerSecond != 0}}">
        <view class="title">本场结束剩余</view>
        <view class="count-down-wrap">
          <text>{{wxTimerList.firstTimer.h}}</text>
          <view>:</view>
          <text>{{wxTimerList.firstTimer.m}}</text>
          <view>:</view>
          <text>{{wxTimerList.firstTimer.s}}</text>
        </view>
      </view>
      <view class="seckillCountdown" wx:if="{{wxTimerList.firstTimer.wxTimerSecond == 0}}">
        <view class="title">本场已结束，请等待下场活动</view>
      </view>
      <!-- 商品 -->
      <view class="saleShopWrap">
        <view class="saleShop">
          <repeat for="{{flowData}}" item="item">
            <view class="shopview" @tap="jumpTimeDetails('{{item.id}}')">
              <image src="http://img011.hc360.cn/g2/M06/45/BF/wKhQuFLfLl-EakIIAAAAAGqrml0128.jpg" />
              <view class="saleTag">
                <text class="overflow-one">{{item.title}}</text>
              </view>
              <view>
                <view>
                  <text class="salep">秒杀价</text>
                  <text class="salesmple">￥</text>
                  <text class="saleprice">{{item.price}}</text>
                  <text class="saleexprice">原价￥ {{item.exprice}}</text>
                </view>
              </view>
            </view>
          </repeat>
        </view>
      </view>
    </view>
    <button
      open-type="getUserInfo"
      id="getUserInfo"
      wx:if="{{userInfoButtonShow}}"
      lang="zh_CN"
      bindgetuserinfo="onGetUserInfo"
    ></button>
    <!-- <button open-type="getUserInfo" id="getUserInfo" lang="zh_CN" @getuserinfo="onGetUserInfo"></button> -->

    <nav @childFn.user="goPage" />
  </view>
</template>

<script>
import wepy from 'wepy';
import nav from '../components/nav'; // 底部导航
var timer = require('../utils/wxTimer.js'); // 倒计时
export default class Index extends wepy.page {
  config = {
    navigationBarTitleText: '首页',
    navigationBarBackgroundColor: 'white'
  };
  components = {
    nav: nav
  };

  mixins = [];

  data = {
    chooesId: '',
    userInfoButtonShow: true,
    userInfo: {},
    requestImgUrl: '',
    beginTime: '18:00',
    ChooesData: [
      { id: '7', img: '/assets/img/image11.png', title: '限时秒杀' },
      { id: '2', img: '/assets/img/image12.png', title: '特卖预购' },
      { id: '5', img: '/assets/img/image13.png', title: '砍价' },
      { id: '1', img: '/assets/img/image14.png', title: '合伙人' },
      { id: '3', img: '/assets/img/image15.png', title: '秒赚钱' },
      { id: '4', img: '/assets/img/image16.png', title: '领券' },
      { id: '6', img: '/assets/img/image17.png', title: '特约商户' },
      { id: '8', img: '/assets/img/image18.png', title: '更多频道' }
    ],
    flowData: [
      {
        id: '1',
        title: '萌分订书机a萌分订书机a萌分订书机a萌分订书机a',
        price: '5',
        exprice: '25',
        img: 'indeximg.png'
      },
      {
        id: '2',
        title: '萌分订书机',
        price: '5',
        exprice: '25',
        img: 'indeximg.png'
      },
      {
        id: '3',
        title: '萌分订书机',
        price: '5',
        exprice: '25',
        img: 'indeximg.png'
      },
      {
        id: '4',
        title: '萌分订书机',
        price: '5',
        exprice: '25',
        img: 'indeximg.png'
      },
      {
        id: '5',
        title: '萌分订书机',
        price: '5',
        exprice: '25',
        img: 'indeximg.png'
      },
      {
        id: '6',
        title: '萌分订书机',
        price: '5',
        exprice: '25',
        img: 'indeximg.png'
      }
    ],
    // 轮播
    imgUrls: [
      { id: '1', img: 'indexlunbo.png' },
      { id: '2', img: 'indexlunbo.png' },
      { id: '3', img: 'indexlunbo.png' },
      { id: '4', img: 'indexlunbo.png' }
    ],
    wxTimerList: {} // 倒计时
  };

  computed = {};
  onLoad() {
    this.onGetUserInfo();
    // 倒计时s
    var wxTimer = new timer({
      beginTime: '6',
      name: 'firstTimer',
      complete() {}
    });
    wxTimer.start(this);
    // setTimeout(() => {
    //   wxTimer.stop();
    // }, 5000);
    // 倒计时e
  }
  onShow() {
    // this.userInfo = this.$parent.globalData.userInfo
    this.requestImgUrl = this.$parent.globalData.requestImgUrl;
  }
  methods = {
    /**
     * 中间选择
     */
    tapName(id) {
      if (id == 1) {
        // this.$navigate({ url: `sale?id=${id}` }); // 促销
        this.$navigate({ url: `applyPartner` }); // 申请合伙人
      } else if (id == 2) {
        this.$navigate({ url: `pre?id=${id}` }); 
      } else if (id == 3) {
        this.$navigate({ url: `discount?id=${id}` });
      } else if (id == 4) {
        // this.$navigate({ url: `sale?id=${id}` }); // 促销
        this.$navigate({ url: `assemble?id=${id}` }); // 拼团
      } else if (id == 5) {
        this.$navigate({ url: `bargain?id=${id}` });
      } else if (id == 6) {
        // this.$navigate({ url: `assemble?id=${id}` }); // 拼团
        this.$navigate({ url: `merchant?id=${id}` }); // 特约商户
      } else if (id == 7) {
        this.$navigate({ url: `seckill?id=${id}` });
      }
    },
    /**
     * 跳转商品详情
     */
    jumpTimeDetails(shopid) {
      console.log('shopid', shopid);
      this.$navigate(`/pages/shopDetails?shopid=${shopid}`);
    },
    /**
     * 底部导航跳转
     */
    goPage(url, evt) {
      // 销毁当前页{跳转}
      this.$redirect(url);
    },
    navSearch() {
      this.$navigate('/pages/search');
    }
  };

  events = {};

  /**
   * 授权
   */
  onGetUserInfo(req) {
    // 查看是否授权
    wx.getSetting({
      success: res => {
        if (res.authSetting['scope.userInfo']) {
          this.userInfoButtonShow = false;
          // 已经授权，可以直接调用 getUserInfo 获取头像昵称
          wx.getUserInfo({
            success: res => {
              this.userInfo = res.userInfo;
              this.$parent.globalData.userInfo = this.userInfo;
              console.log(res);

              // let avatarUrl = res.userInfo.avatarUrl
              // //登录
              // wx.login({
              //   success: res => {

              //     if (res.code) {
              //       //发起网络请求
              //       wx.request({
              //         url: app.config.backUrl + 'apiLogin/login',
              //         method: 'POST',
              //         data: {
              //           img: avatarUrl,
              //           code: res.code
              //         },
              //         success: function(res) {
              //           /**世豪信息 */
              //           app.globalData.userInfo = res.data.data
              //           // 存用户id
              //           app.globalData.uid = res.data.data.id

              //           // 存token
              //           // console.log('token=' + res.data.data.token)
              //         }
              //       })
              //     } else {
              //       console.log('获取用户登录态失败！' + res.errMsg)
              //     }
              //   }
              // })
              // app.globalData.userInfo = userInfo
              // if (this.data.userInfo) {
              //   // 提交用户信息
              //   // this.setUserInfo(this.userInfo)
              //   app.globalData.userInfo = this.userInfo
              //   this.$apply()
              // }
            }
          });
        } else {
          // this.clickWeekBangs()
        }
      }
    });
  }
}
</script>

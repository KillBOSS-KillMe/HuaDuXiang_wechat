"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _asyncToGenerator(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,a){function r(s,n){try{var i=e[s](n),o=i.value}catch(t){return void a(t)}if(!i.done)return Promise.resolve(o).then(function(t){r("next",t)},function(t){r("throw",t)});t(o)}return r("next")})}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var a=arguments[e];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(t[r]=a[r])}return t},_createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,a,r){return a&&t(e.prototype,a),r&&t(e,r),e}}(),_ajax=require("./../ajax.js"),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_mask=require("./../components/mask.js"),_mask2=_interopRequireDefault(_mask),api=require("./../api.js"),Settlement=function(t){function e(){var t,a,r,s;_classCallCheck(this,e);for(var n=arguments.length,i=Array(n),o=0;o<n;o++)i[o]=arguments[o];return a=r=_possibleConstructorReturn(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(i))),r.config={navigationBarTitleText:"提交订单"},r.$repeat={},r.$props={paymask:{"xmlns:v-bind":"","v-bind:maskFlag.sync":"payFlag"}},r.$events={},r.components={paymask:_mask2.default},r.mixins=[],r.data={payFlag:!1,priceArr:[{title:"微信支付",icon:"image57.png",flag:1},{title:"余额支付",icon:"image58.png",flag:0}],requestImgUrl:"",address:null,goods_list:[],store_cart_list:[],allPrice:0,goodsAllNum:0,address_api:null,vat_hash:null,cart_id:null,payment_list:[],goods_freight:0,payment_type:0,available_predeposit:0,password:"",postage:{},pay_sn:"",disabledSwitch:!1,predepositFlag:!0,mini_wxpayFlag:!0},r.computed={disabledSwitch:function(){return this.available_predeposit<this.allPrice||!this.predepositFlag}},r.methods={inputpassword:function(t){this.password=t.detail.value},clickSwitch:function(){var t=this;if(!this.predepositFlag)return wx.showToast({title:"余额支付暂未开启，请使用微信支付",icon:"none"}),!1;this.available_predeposit<this.allPrice&&(this.payment_type=0,wx.showModal({title:"提醒",content:"余额不足，是否前往充值？",success:function(e){e.confirm&&t.$redirect("vip")}}))},changePayment:function(t){this.payment_type=Number(t.detail.value),this.password=""},getWXPayment:function(){var t=this;return this.address.address_id?this.pay_sn?(this.payFlag=!0,!1):void(0,_ajax.ajax)({url:api.placeOrder,data:{cart_id:this.cart_id,ifcart:0,address_id:this.address.address_id,vat_hash:this.vat_hash,offpay_hash:this.address_api.offpay_hash,offpay_hash_batch:this.address_api.offpay_hash_batch,pay_name:"online",invoice_id:0,voucher:null}}).then(function(e){200==e.code?(t.payFlag=!0,t.pay_sn=e.datas.pay_sn,t.$apply(),t.requestPayType()):wx.showToast({title:"网络错误，请稍后再试",icon:"none"})}):(wx.showToast({title:"请选择地址",icon:"none"}),!1)},pay:function(){function t(){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function t(){var e,a,r,s;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(e=this,1!=this.payment_type){t.next=11;break}if(this.password){t.next=5;break}return wx.showToast({title:"请输入密码",icon:"none"}),t.abrupt("return",!1);case 5:return t.next=7,(0,_ajax.ajax)({url:api.checkPassword,data:{password:this.password}});case 7:if(a=t.sent,0!=a.datas.state){t.next=11;break}return wx.showToast({title:"密码错误，请重新输入",icon:"none"}),t.abrupt("return",!1);case 11:return t.next=13,(0,_ajax.ajax)({url:api.pay,data:{pay_sn:this.pay_sn,payment_code:0==this.payment_type?"mini_wxpay":"predeposit",password:this.password,pd_pay:this.payment_type}}).then(function(t){return t.datas});case 13:r=t.sent,0==r.state&&wx.showToast({title:r.msg,icon:"none"}),1==r.state&&(0==this.payment_type?wx.requestPayment(_extends({},r.api_pay,{success:function(t){wx.showToast({title:"支付成功"})},fail:function(t){wx.showToast({title:"支付失败"})},complete:function(){var t=setTimeout(function(){e.$redirect("orderlist"),clearTimeout(t)},1e3)}})):(wx.showToast({title:"支付成功"}),s=setTimeout(function(){e.$redirect("orderlist"),clearTimeout(s)},1e3)));case 16:case"end":return t.stop()}},t,this)}));return t}()},r.events={},s=a,_possibleConstructorReturn(r,s)}return _inherits(e,t),_createClass(e,[{key:"requestPayType",value:function(){var t=this;(0,_ajax.ajax)({url:api.payInfo,data:{pay_sn:this.pay_sn}}).then(function(e){200==e.code&&(t.mini_wxpayFlag=e.datas.pay_info.mini_wxpay,t.predepositFlag=e.datas.pay_info.predeposit,t.$apply())})}},{key:"onLoad",value:function(t){}},{key:"onShow",value:function(){this.requestImgUrl=this.$parent.globalData.requestImgUrl;var t=this.$parent,e=t.globalData.orderInfo;this.postage=e.address_api.content||{},this.address="[object Object]"==Object.prototype.toString.call(e.address_info)?e.address_info:"",this.store_cart_list=e.store_cart_list;var a=[];Object.values(e.store_cart_list).forEach(function(t){a=a.concat(t.goods_list)});var r=0;a.forEach(function(t){r+=Number(t.goods_num)}),this.goodsAllNum=r,this.allPrice=Number(e.order_amount).toFixed(2),this.address_api=e.address_api,this.vat_hash=e.vat_hash,this.cart_id=e.submitData.cart_id,this.goods_freight=e.goods_freight,this.available_predeposit=Number(e.available_predeposit)}}]),e}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Settlement,"pages/settlement"));
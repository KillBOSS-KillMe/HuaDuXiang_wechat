"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,a){function r(s,n){try{var i=t[s](n),o=i.value}catch(e){return void a(e)}if(!i.done)return Promise.resolve(o).then(function(e){r("next",e)},function(e){r("throw",e)});e(o)}return r("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},_createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),_ajax=require("./../ajax.js"),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_mask=require("./../components/mask.js"),_mask2=_interopRequireDefault(_mask),api=require("./../api.js"),Settlement=function(e){function t(){var e,a,r,s;_classCallCheck(this,t);for(var n=arguments.length,i=Array(n),o=0;o<n;o++)i[o]=arguments[o];return a=r=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(i))),r.config={navigationBarTitleText:"提交订单"},r.$repeat={},r.$props={paymask:{"xmlns:v-bind":"","v-bind:maskFlag.sync":"payFlag"}},r.$events={},r.components={paymask:_mask2.default},r.mixins=[],r.data={payFlag:!1,priceArr:[{title:"微信支付",icon:"image57.png",flag:1},{title:"余额支付",icon:"image58.png",flag:0}],requestImgUrl:"",address:null,goods_list:[],store_cart_list:[],allPrice:0,goodsAllNum:0,address_api:null,vat_hash:null,cart_id:null,payment_list:[],goods_freight:0,payment_type:0,available_predeposit:0,password:"",postage:{},pay_sn:"",disabledSwitch:!1,predepositFlag:!0,mini_wxpayFlag:!0},r.computed={disabledSwitch:function(){return this.available_predeposit<this.allPrice||!this.predepositFlag}},r.methods={inputPassword:function(e){this.password=e.detail.value},clickSwitch:function(){var e=this;if(!this.predepositFlag)return wx.showToast({title:"余额支付暂未开启，请使用微信支付",icon:"none"}),!1;this.available_predeposit<this.allPrice&&(this.payment_type=0,wx.showModal({title:"提醒",content:"余额不足，是否前往充值？",success:function(t){t.confirm&&e.$redirect("vip")}}))},changePayment:function(e){this.payment_type=Number(e.detail.value),this.password=""},getWXPayment:function(){var e=this;return this.address.address_id?this.pay_sn?(this.payFlag=!0,!1):void(0,_ajax.ajax)({url:api.placeOrder,data:{cart_id:this.cart_id,ifcart:0,address_id:this.address.address_id,vat_hash:this.vat_hash,offpay_hash:this.address_api.offpay_hash,offpay_hash_batch:this.address_api.offpay_hash_batch,pay_name:"online",invoice_id:0,voucher:null}}).then(function(t){200==t.code?(e.payFlag=!0,e.pay_sn=t.datas.pay_sn,e.$apply(),e.requestPayType()):wx.showToast({title:"网络错误，请稍后再试",icon:"none"})}):(wx.showToast({title:"请选择地址",icon:"none"}),!1)},pay:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,a,r,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this,1!=this.payment_type){e.next=11;break}if(this.password){e.next=5;break}return wx.showToast({title:"请输入密码",icon:"none"}),e.abrupt("return",!1);case 5:return e.next=7,(0,_ajax.ajax)({url:api.checkPassword,data:{password:this.password}});case 7:if(a=e.sent,0!=a.datas.state){e.next=11;break}return wx.showToast({title:"密码错误，请重新输入",icon:"none"}),e.abrupt("return",!1);case 11:return e.next=13,(0,_ajax.ajax)({url:api.pay,data:{pay_sn:this.pay_sn,payment_code:0==this.payment_type?"mini_wxpay":"predeposit",password:this.password,pd_pay:this.payment_type}}).then(function(e){return e.datas});case 13:r=e.sent,0==r.state&&wx.showToast({title:r.msg,icon:"none"}),1==r.state&&(0==this.payment_type?wx.requestPayment(_extends({},r.api_pay,{success:function(e){wx.showToast({title:"支付成功"})},fail:function(e){wx.showToast({title:"支付失败"})},complete:function(){var e=setTimeout(function(){t.$redirect("orderlist"),clearTimeout(e)},1e3)}})):(wx.showToast({title:"支付成功"}),s=setTimeout(function(){t.$redirect("orderlist"),clearTimeout(s)},1e3)));case 16:case"end":return e.stop()}},e,this)}));return e}()},r.events={},s=a,_possibleConstructorReturn(r,s)}return _inherits(t,e),_createClass(t,[{key:"requestPayType",value:function(){var e=this;(0,_ajax.ajax)({url:api.payInfo,data:{pay_sn:this.pay_sn}}).then(function(t){200==t.code&&(e.mini_wxpayFlag=t.datas.pay_info.mini_wxpay,e.predepositFlag=t.datas.pay_info.predeposit,e.$apply())})}},{key:"onLoad",value:function(e){}},{key:"onShow",value:function(){this.requestImgUrl=this.$parent.globalData.requestImgUrl;var e=this.$parent,t=e.globalData.orderInfo;this.postage=t.address_api.content||{},this.address="[object Object]"==Object.prototype.toString.call(t.address_info)?t.address_info:"",this.store_cart_list=t.store_cart_list;var a=[];Object.values(t.store_cart_list).forEach(function(e){a=a.concat(e.goods_list)});var r=0;a.forEach(function(e){r+=Number(e.goods_num)}),this.goodsAllNum=r,this.allPrice=Number(t.order_amount).toFixed(2),this.address_api=t.address_api,this.vat_hash=t.vat_hash,this.cart_id=t.cart_id,this.goods_freight=t.goods_freight,this.available_predeposit=Number(t.available_predeposit)}}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Settlement,"pages/settlement"));
"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,a){function r(n,s){try{var i=t[n](s),o=i.value}catch(e){return void a(e)}if(!i.done)return Promise.resolve(o).then(function(e){r("next",e)},function(e){r("throw",e)});e(o)}return r("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},_createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_ajax=require("./../ajax.js"),_mask=require("./../components/mask.js"),_mask2=_interopRequireDefault(_mask),api=require("./../api.js"),ShopCart=function(e){function t(){var e,a,r,n;_classCallCheck(this,t);for(var s=arguments.length,i=Array(s),o=0;o<s;o++)i[o]=arguments[o];return a=r=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(i))),r.config={navigationBarTitleText:"订单列表",enablePullDownRefresh:!0},r.$repeat={},r.$props={paymask:{"xmlns:v-bind":"","v-bind:maskFlag.sync":"payFlag"}},r.$events={},r.components={paymask:_mask2.default},r.mixins=[],r.data={navArr:[{title:"全部",id:0},{title:"待付款"},{title:"待发货"},{title:"待收货"},{title:"已完成"}],navIdx:0,orderList:[],state_arr:["","state_new","state_pay","state_send","state_noeval"],curpage:1,hasmore:!1,page_total:"",disabledSwitch:!1,allPrice:0,available_predeposit:0,payment_type:0,payFlag:!1,predepositFlag:!0,mini_wxpayFlag:!0,order_id:"",pay_sn:"",password:""},r.computed={disabledSwitch:function(){return this.available_predeposit<this.allPrice||!this.predepositFlag}},r.methods={clickSwitch:function(){var e=this;if(!this.predepositFlag)return wx.showToast({title:"余额支付暂未开启，请使用微信支付",icon:"none"}),!1;this.available_predeposit<this.allPrice&&(this.payment_type=0,wx.showModal({title:"提醒",content:"余额不足，是否前往充值？",success:function(t){t.confirm&&e.$redirect("vip")}}))},inputPassword:function(e){this.password=e.detail.value},changePayment:function(e){this.payment_type=Number(e.detail.value)},orderCancel:function(e,t){var a=this;wx.showModal({title:"确认取消订单?",success:function(r){r.confirm&&(0,_ajax.ajax)({url:api.orderCancel,data:{order_id:e}}).then(function(e){1==e.datas.state?(wx.showToast({title:e.datas.msg}),a.orderList[t].order_state=e.datas.order_state,a.$apply()):wx.showToast({title:e.datas.error,icon:"none"})})}})},orderDelete:function(e,t){var a=this;wx.showModal({title:"确认删除订单?",success:function(r){r.confirm&&(0,_ajax.ajax)({url:api.orderDelete,data:{order_id:e}}).then(function(e){1==e.datas.state?(wx.showToast({title:e.datas.msg}),a.orderList.splice(t,1),a.$apply()):wx.showToast({title:e.datas.error,icon:"none"})})}})},orderReceive:function(e,t){var a=this;wx.showModal({title:"确认收货?",success:function(r){r.confirm&&(0,_ajax.ajax)({url:api.orderReceive,data:{order_id:e}}).then(function(e){1==e.datas.state?(wx.showToast({title:e.datas.msg}),a.orderList[t].order_state=e.datas.order_state,a.$apply()):wx.showToast({title:e.datas.error,icon:"none"})})}})},getWXPayment:function(e,t,a){this.payFlag=!0,this.allPrice=Number(a),this.order_id=e,this.pay_sn=t,this.requestPayType()},pay:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,a,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this,1!=this.payment_type){e.next=11;break}if(this.password){e.next=5;break}return wx.showToast({title:"请输入密码",icon:"none"}),e.abrupt("return",!1);case 5:return e.next=7,(0,_ajax.ajax)({url:api.checkPassword,data:{password:this.password}});case 7:if(a=e.sent,0!=a.datas.state){e.next=11;break}return wx.showToast({title:"密码错误，请重新输入",icon:"none"}),e.abrupt("return",!1);case 11:return e.next=13,(0,_ajax.ajax)({url:api.pay,data:{pay_sn:this.pay_sn,payment_code:0==this.payment_type?"mini_wxpay":"predeposit",password:this.password,pd_pay:this.payment_type}}).then(function(e){return e.datas});case 13:r=e.sent,0==r.state&&wx.showToast({title:r.msg,icon:"none"}),1==r.state&&(0==this.payment_type?wx.requestPayment(_extends({},r.api_pay,{success:function(e){wx.showToast({title:"支付成功"})},fail:function(e){wx.showToast({title:"支付失败"})},complete:function(){var e=setTimeout(function(){t.$redirect("orderlist"),clearTimeout(e)},1e3)}})):(wx.showToast({title:"支付成功"}),n=setTimeout(function(){t.$redirect("orderlist"),clearTimeout(n)},1e3)));case 16:case"end":return e.stop()}},e,this)}));return e}(),changeNav:function(e){e!=this.navIdx&&(this.navIdx=e,this.hasmore=!1,this.curpage=1,this.orderList=[],this.requestList())}},r.events={},n=a,_possibleConstructorReturn(r,n)}return _inherits(t,e),_createClass(t,[{key:"requestPayType",value:function(){var e=this;(0,_ajax.ajax)({url:api.payInfo,data:{pay_sn:this.pay_sn}}).then(function(t){200==t.code&&(e.mini_wxpayFlag=t.datas.pay_info.mini_wxpay,e.predepositFlag=t.datas.pay_info.predeposit,e.$apply())})}},{key:"onLoad",value:function(e){var t=this;this.navIdx=e.idx||0,(0,_ajax.ajax)({url:api.memberInfo}).then(function(e){200==e.code&&(t.available_predeposit=Number(e.datas.member_data.available_predeposit),t.$apply())}),this.requestList()}},{key:"onShow",value:function(){}},{key:"requestList",value:function(){var e=this;(0,_ajax.ajax)({url:api.orderList,data:{page:10,curpage:this.curpage,state_type:this.state_arr[this.navIdx]}}).then(function(t){var a=t.datas.order_group_list||[],r=[];a.forEach(function(e){r=r.concat(e.order_list)}),e.orderList=e.orderList.concat(r),e.page_total=t.page_total,e.hasmore=t.hasmore,e.$apply(),wx.stopPullDownRefresh()})}},{key:"onReachBottom",value:function(){this.hasmore&&(this.curpage++,this.requestList())}},{key:"onPullDownRefresh",value:function(e){this.curpage=1,this.orderList=[],this.hasmore=!1,this.requestList()}}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(ShopCart,"pages/orderlist"));
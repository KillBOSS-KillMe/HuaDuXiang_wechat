"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _asyncToGenerator(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,s){function a(i,o){try{var n=e[i](o),r=n.value}catch(t){return void s(t)}if(!n.done)return Promise.resolve(r).then(function(t){a("next",t)},function(t){a("throw",t)});t(r)}return a("next")})}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function t(t,e){for(var s=0;s<e.length;s++){var a=e[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,s,a){return s&&t(e.prototype,s),a&&t(e,a),e}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_mask=require("./../components/mask.js"),_mask2=_interopRequireDefault(_mask),_ajax=require("./../ajax.js"),_base=require("./../utils/base.js"),api=require("./../api.js"),WxParse=require("./../utils/wxParse/wxParse.js"),timer=require("./../utils/wxTimer.js"),Index=function(t){function e(){var t,s,a,i;_classCallCheck(this,e);for(var o=arguments.length,n=Array(o),r=0;r<o;r++)n[r]=arguments[r];return s=a=_possibleConstructorReturn(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(n))),a.config={navigationBarTitleText:"商品详情"},a.$repeat={},a.$props={attrsmask:{"xmlns:v-bind":"","v-bind:maskFlag.sync":"attrFlag"},asslistmask:{"v-bind:maskFlag.sync":"asslistFlag"},participatemask:{"v-bind:maskFlag.sync":"participateFlag"},couponmask:{"v-bind:maskFlag.sync":"couponFlag"}},a.$events={},a.components={attrsmask:_mask2.default,asslistmask:_mask2.default,participatemask:_mask2.default,couponmask:_mask2.default},a.mixins=[],a.data={couponFlag:!1,goodsNum:1,attrFlag:!1,tabList:[{name:"商品介绍"},{name:"图文详情"}],currentTab:0,goods_id:null,requestImgUrl:null,goods_content:null,store_info:null,goods_commend_list:[],image_list:[],contractlist:{},attr:[],activeAttr:[],goods_spec:[],spec_list:{},sale_type:"",voucher_list:[],address_list:[],distState:0,userid:null,waitForArr:[],wxTimerList:{},asslistFlag:!1,participateFlag:!1,currentAssembleIdx:null,currentAssembleData:null},a.computed={},a.watch={currentAssembleIdx:function(t,e){this.currentAssembleData=this.waitForArr.filter(function(e,s){return s==t})[0],console.log(this.currentAssembleData)}},a.methods={switchNav:function(t){this.currentTab=t},showAttrMask:function(){this.currentAssembleData=null,this.attrFlag=!0},attrBtnSubmit:function(){this.submit()},addNum:function(){this.goodsNum++},reduNum:function(){if(this.goodsNum<=1)return this.goodsNum=1,!1;this.goodsNum--},changeAttr:function(t,e,s){this.activeAttr[t]=e,this.goods_spec[t]=s;var a=this.spec_list[this.activeAttr.join("|")];this.goods_id=a,this.$apply(),this.getShopDetails()},addCart:function(){var t=this;(0,_ajax.ajax)({url:api.cartAdd,data:{goods_id:this.goods_id,quantity:this.goodsNum}}).then(function(e){1==e.datas.state?(wx.showToast({title:"添加成功"}),t.attrFlag=!1,t.$apply()):wx.showToast({title:e.datas.error,icon:"none"})})},navGoodsDetails:function(t,e){"rushsales"==e?this.$redirect("/pages/seckillShopDetails?goods_id="+t):this.$redirect("/pages/shopDetails?goods_id="+t)},showCouponMask:function(){if(0==this.voucher_list.length)return wx.showToast({title:"暂无优惠券发送",icon:"none"}),!1;this.couponFlag=!0},choiceCoupon:function(t,e,s){var a=this;0==t&&(0,_ajax.ajax)({url:api.voucherFreeex,data:{tid:e}}).then(function(t){1==t.datas?(wx.showToast({title:"领取成功"}),a.voucher_list[s].exists=1,a.$apply()):wx.showToast({title:t.datas.error,icon:"none"})})},hideCoupon:function(){this.couponFlag=!1},hideAsslistMask:function(){this.asslistFlag=!1},showAsslistMask:function(){this.asslistFlag=!0},showParticipateMask:function(t){if(this.wxTimerList["timer"+t].wxTimerSecond<=0)return wx.showToast({title:"拼团已结束",icon:"none"}),!1;this.currentAssembleIdx=t,this.participateFlag=!0,this.asslistFlag=!1},hideParticipateMask:function(t){this.participateFlag=!1},navAssembleShopDetails:function(){this.goodsNum=1,this.submit(),this.participateFlag=!1}},a.events={},i=s,_possibleConstructorReturn(a,i)}return _inherits(e,t),_createClass(e,[{key:"onShow",value:function(){var t=this;(0,_ajax.ajax)({url:api.addressList}).then(function(e){t.address_list=e.datas.address_list||[],t.$apply()})}},{key:"submit",value:function(){var t=this,e=this,s=this.$parent,a=this.goods_id,i=this.goodsNum,o=a+"|"+i,n={cart_id:o,address_id:"",pingou:"group"==this.sale_type?1:0,fx_id:this.userid?1:0,log_id:this.currentAssembleData?this.currentAssembleData.log_id:"",buyer_id:this.currentAssembleData?this.currentAssembleData.buyer_id:"",is_book:this.goods_content.is_book};(0,_ajax.ajax)({url:api.memberBuyOne,data:n}).then(function(a){if(200==a.code){if(0==a.datas.state)return wx.showToast({title:a.datas.msg,icon:"none"}),!1;a.datas.submitData=n,s.globalData.orderInfo=a.datas,e.address_list.length?t.$navigate({url:"/pages/settlement"}):wx.showModal({title:"提醒",content:"暂无地址，添加新地址",success:function(t){t.confirm&&e.$navigate({url:"consignee"})}})}else 400==a.code&&wx.showToast({title:a.datas.error,icon:"none"})})}},{key:"onShareAppMessage",value:function(t){var e=wx.getStorageSync("user");return{path:"/pages/shopDetails?goods_id="+this.goods_id+"&userid="+e.userid}}},{key:"onLoad",value:function(){function t(t){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var s,a=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.timer&&this.timer.forEach(function(t){t.stop()}),s=this,this.userid=e.userid,this.requestImgUrl=this.$parent.globalData.requestImgUrl,this.goods_id=e.goods_id,this.$apply(),t.next=8,this.getShopDetails();case 8:(0,_ajax.ajax)({url:api.voucherTplList,data:{store_id:this.store_info.store_id,gettype:"free"}}).then(function(t){var e=t.datas.voucher_list||[];e.forEach(function(t){t.couponTime=(0,_base.formatDate)(t.voucher_t_start_date)+" 至 "+(0,_base.formatDate)(t.voucher_t_end_date)}),a.voucher_list=e,a.$apply()}),(0,_ajax.ajax)({url:api.getpingoulist,data:{goods_id:e.goods_id}}).then(function(t){a.timer=[];var e=t.datas||[];e.forEach(function(t,e){a.timer[e]=new timer({beginTime:t.over_time,name:"timer"+e}),a.timer[e].start(s)}),a.waitForArr=e,a.$apply()});case 10:case"end":return t.stop()}},t,this)}));return t}()},{key:"getShopDetails",value:function(){function t(){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function t(){var e,s=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=this,t.next=3,(0,_ajax.ajax)({url:api.ordinaryGoodsDtail,type:"get",data:{goods_id:this.goods_id}}).then(function(t){if(200==t.code){s.goods_content=t.datas.goods_content,s.sale_type=t.datas.goods_content.sale_type,s.contractlist=t.datas.goods_content.contractlist||{},s.image_list=t.datas.image_list||[],s.store_info=t.datas.store_info,s.goods_commend_list=t.datas.goods_commend_list;var a=Object.values(t.datas.goods_content.spec_name||{}),i=Object.values(t.datas.goods_content.spec_value||{}),o=[];i.forEach(function(t,e){o[e]||(o[e]={}),o[e].title=a[e],o[e].prop=t}),s.attr=o,s.goods_spec=Object.values(t.datas.goods_content.goods_spec||{}),s.activeAttr=Object.keys(t.datas.goods_content.goods_spec||{}),s.spec_list=t.datas.spec_list,s.$apply();var n=t.datas.goods_content.goods_body;WxParse.wxParse("article","html",n,e,5)}});case 3:case"end":return t.stop()}},t,this)}));return t}()},{key:"getpingoulist",value:function(){}},{key:"onHide",value:function(){this.attrFlag=!1}}]),e}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Index,"pages/shopDetails"));